############
## SPACES ##
############

- space: VirtualLab
  alignWithSegment:
    segment: Hips

- parameter: VirtualLabOrigin
  steps:
    - vector: [Hips.x, Hips.x, Hips.x]
    - multiply: [$prev, 0]

- segment: VirtualLabSegment
  steps:
    - segment:
      origin: VirtualLabOrigin
      primaryAxis: [[0,0,0], [1,0,0]]
      secondaryAxis: [[0,0,0], [0,0,1]]
      order: yz 

############
## EVENTS ##
############

- template: /templates/events-kinetics.calqulus.yaml
  where:
    force: any

- template: running-events-kinematics.calqulus.yaml

############
## SERIES ##
############

- template: /templates/timeseries.calqulus.yaml

# --- event detection related parameters ---
- parameter: Left_MID_FOOT_vel
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot
      space: VirtualLab
    - convert:
      from: mm
      to: m
    - lowpass:
      extrapolate: 100
      cutoff: 16
      export: Left_MID_FOOT
    - velocity:
    - lowpass:
      extrapolate: 100
      cutoff: 16

- parameter: Left_MID_FOOT_acc
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot
      space: VirtualLab
    - convert:
      from: mm
      to: m
    - lowpass:
      extrapolate: 100
      cutoff: 12
    - acceleration:
    - lowpass:
      extrapolate: 100
      cutoff: 20

- parameter: LAnkle
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - vector: [LeftAnkle.x, LeftAnkle.y, LeftAnkle.z]

- parameter: LeftHeelBack
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - if: exists(LHeelBack)
      then: LHeelBack
      else: LAnkle

- parameter: LHeelBack_vel
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - import: LeftHeelBack
    - velocity:

- parameter: Right_MID_FOOT_vel
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot
      space: VirtualLab
    - convert:
      from: mm
      to: m
    - lowpass:
      extrapolate: 100
      cutoff: 16
      export: Right_MID_FOOT
    - velocity:
    - lowpass:
      extrapolate: 100
      cutoff: 16

- parameter: Right_MID_FOOT_acc
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot
      space: VirtualLab
    - convert:
      from: mm
      to: m
    - lowpass:
      extrapolate: 100
      cutoff: 12
    - acceleration:
    - lowpass:
      extrapolate: 100
      cutoff: 20

- parameter: RAnkle
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - vector: [RightAnkle.x, RightAnkle.y, RightAnkle.z]

- parameter: RightHeelBack
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - if: exists(RHeelBack)
      then: RHeelBack
      else: RAnkle

- parameter: RHeelBack_vel
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - import: RightHeelBack
    - velocity:

# Midstance event is based on pelvis position wrt foot position
- parameter: Pelvis_CGPos
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: Hips
      space: VirtualLab
    - convert:
      from: mm
      to: m

# Footstrike
- parameter: LForefoot2_wrt_Pelvis
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - vector: [LeftToeBase.x, LeftToeBase.y, LeftToeBase.z]
      space: VirtualLab
      output: foot
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [foot, pelvis]
  
- parameter: LHeelBack_wrt_Pelvis
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - import: LeftHeelBack => heel
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [heel, pelvis]
  
- parameter: RForefoot2_wrt_Pelvis
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - vector: [RightToeBase.x, RightToeBase.y, RightToeBase.z]
      space: VirtualLab
      output: foot
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [foot, pelvis]
  
- parameter: RHeelBack_wrt_Pelvis
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - import: RightHeelBack => heel
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [heel, pelvis]

- parameter: Pelvis_COG_range
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Hips
      space: VirtualLab
    - convert:
      from: mm
      to: m
    - range: $prev.y
# -----------------

# # --- Pelvis ---

- parameter: Left Knee Angles_Velocity
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - velocity: Left Knee Angles => kneeAngleVel

- parameter: Right Knee Angles_Velocity
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - velocity: Right Knee Angles => kneeAngleVel

# # ---

- parameter: Left_KNEE_Lin_Velocity
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftLeg
    - velocity: $prev
      space: VirtualLab
    - convert:
      from: mm/s
      to: m/s

- parameter: Right_KNEE_Lin_Velocity
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightLeg
    - velocity: $prev
      space: VirtualLab
    - convert:
      from: mm/s
      to: m/s

# ---

- parameter: L_KNEE_X
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftLeg => shank
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [pelvis, shank]
    - multiply: [$prev.y,-1]
    - convert:
      from: mm
      to: m

- parameter: R_KNEE_X
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightLeg
    - segment: Hips
    - subtract: [Hips, RightLeg]
      space: VirtualLab
    - multiply: [$prev.y,-1]
    - convert:
      from: mm
      to: m

# ---

- parameter: LEFT_KNEE
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftLeg => shank
      space: VirtualLab
    - convert: shank
      from: mm
      to: m

- parameter: RIGHT_KNEE
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightLeg => shank
      space: VirtualLab
    - convert: shank
      from: mm
      to: m

# --- Ankle ---

- parameter: Left Tibial Rotation
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: [LeftFoot, LeftLeg]
    - multiply: [$prev, [1, 1, -1]]

- parameter: Right Tibial Rotation
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: [RightFoot, RightLeg]

# ---

- parameter: Left Tibial Rotation_Velocity
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - velocity: Left Tibial Rotation => tibialRotVel

- parameter: Right Tibial Rotation_Velocity
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - velocity: Right Tibial Rotation => tibialRotVel

# ---

- parameter: Left Ankle Angles_Velocity
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - velocity: Left Ankle Angles => ankleAngleVel

- parameter: Right Ankle Angles_Velocity
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - velocity: Right Ankle Angles => ankleAngleVel

# ---

- parameter: Left Foot Contact Angle_shifted
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: LeftFoot => footContactAngle
      space: VirtualLab
      axis: ["X"]

- parameter: Right Foot Contact Angle_shifted
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: RightFoot => footContactAngle
      space: VirtualLab
      axis: ["X"]

# ---

- parameter: L_ANKLE_Y
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => foot
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [pelvis, foot]
      output: ankle

    - multiply: [ankle.y,[-1]]
    - convert:
      from: mm
      to: m
      export: L_ANKLE_X

    - convert: ankle.x
      from: mm
      to: m

- parameter: R_ANKLE_Y
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - subtract: [Hips, RightFoot]
      space: VirtualLab
      output: ankle

    - multiply: [ankle.y,-1]
    - convert:
      from: mm
      to: m
      export: R_ANKLE_X

    - convert: ankle.x
      from: mm
      to: m

# ---

- parameter: LEFT_ANKLE
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => ankle
      space: VirtualLab
    - convert: ankle
      from: mm
      to: m

- parameter: RIGHT_ANKLE
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot => ankle
      space: VirtualLab
    - convert: ankle
      from: mm
      to: m

# ---

- parameter: Left_ANKLE_Lin_Velocity
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot
      space: VirtualLab
    - velocity:
    - convert:
      from: mm/s
      to: m/s

- parameter: Right_ANKLE_Lin_Velocity
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot
      space: VirtualLab
    - velocity:
    - convert:
      from: mm/s
      to: m/s

# --- Upper body ---

- parameter: Trunk Angles_wrt_LAB
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: Spine2
      space: VirtualLab
    - multiply: [$prev, [-1,1,1]]

- parameter: Shoulder_Pelvis Angle
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: [Hips, Spine2]

# --- Arms ---

- parameter: L_ELBOW_RT_PELVIS_Y
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - subtract: [LeftForeArm, Hips]
      space: VirtualLab
      output: elbowPelvis
    - convert: elbowPelvis.y
      from: mm
      to: m
      export: L_ELBOW_RT_PELVIS_X

    - convert: elbowPelvis.z
      from: mm
      to: m
      export: L_ELBOW_RT_PELVIS_Z

    - multiply: [elbowPelvis.x,-1]
    - convert:
      from: mm
      to: m

- parameter: R_ELBOW_RT_PELVIS_Y
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - subtract: [RightForeArm, Hips]
      space: VirtualLab
      output: elbowPelvis
    - convert: elbowPelvis.y
      from: mm
      to: m
      export: R_ELBOW_RT_PELVIS_X

    - convert: elbowPelvis.z
      from: mm
      to: m
      export: R_ELBOW_RT_PELVIS_Z

    - multiply: [elbowPelvis.x,-1]
    - convert:
      from: mm
      to: m

# ---

- parameter: L_WRIST_RT_PELVIS_Y
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - subtract: [LeftHand, Hips]
      space: VirtualLab
      output: wristPelvis
    - convert: wristPelvis.y
      from: mm
      to: m
      export: L_WRIST_RT_PELVIS_X

    - convert: wristPelvis.z
      from: mm
      to: m
      export: L_WRIST_RT_PELVIS_Z

    - multiply: [wristPelvis.x,-1]
    - convert:
      from: mm
      to: m

- parameter: R_WRIST_RT_PELVIS_Y
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - subtract: [RightHand, Hips]
      space: VirtualLab
      output: wristPelvis
    - convert: wristPelvis.y
      from: mm
      to: m
      export: R_WRIST_RT_PELVIS_X

    - convert: wristPelvis.z
      from: mm
      to: m
      export: R_WRIST_RT_PELVIS_Z

    - multiply: [wristPelvis.x,-1]
    - convert:
      from: mm
      to: m

# --- 
- parameter: L_ankle_crossing_pelvis
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: Hips => pelvis
      space: VirtualLab
    - convert: pelvis
      from: mm
      to: m
      output: pel
    - subtract: [pel.y, LEFT_ANKLE.y]

- parameter: R_ankle_crossing_pelvis
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: Hips => pelvis
    - convert: pelvis
      from: mm
      to: m
      space: VirtualLab
      output: pel
    - subtract: [pel.y, RIGHT_ANKLE.y]

#############
## Metrics ##
#############

# Treadmill speed (calculated from left foot and right foot at midstance)
- parameter: left_treadmill_speed
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - velocity: l_foot => l_foot_vel
    - multiply: [l_foot_vel.y, -1]
      output: l_foot_vel_inv
    - mean: l_foot_vel_inv@L_MID_STANCE
    
- parameter: right_treadmill_speed
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot => r_foot
      space: VirtualLab
    - velocity: r_foot => r_foot_vel
    - multiply: [r_foot_vel.y, -1]
      output: r_foot_vel_inv
    - mean: r_foot_vel_inv@R_MID_STANCE

- parameter: treadmill_speed
  where:
    name: ^(Running|Gait)*
  steps:
    - concatenate: [left_treadmill_speed, right_treadmill_speed]
    - mean:
    - convert:
      from: mm/s
      to: m/s

- parameter: actual_running_speed_ms
  where:
    name: ^(Running|Gait)*
  steps:
    - velocity: Hips => pelvis_vel
      space: VirtualLab
    - convert: pelvis_vel
      from: mm/s
      to: m/s
    - add: [$prev, treadmill_speed]
      output: pelvis_vel_adj
    - mean: pelvis_vel_adj.y
      export: walking_speed # for FA report

# Seconds per meter, to be displayed as minutes per kilometer.
- parameter: seconds_per_meter
  where:
    name: ^(Running|Gait)*
  steps:
    - divide: [1, actual_running_speed_ms]

# Statures per second
# calculated as average speed divided by the subject height 
- parameter: Statures_Per_Second
  where:
    name: ^(Running|Gait)*
  steps:
    - divide: [actual_running_speed_ms, "$field(Height; measurement; numeric)"]

# Stride angle
- parameter: Left Stride Angle@max
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftUpLeg => l_thigh
    - segment: RightUpLeg => r_thigh
    - jointAngle: [l_thigh, r_thigh]
      export: Left Stride Angle
    - eventMask: [$prev, LFS, LFS]
      output: angle
    - max: angle.x
     
- parameter: Right Stride Angle@max
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftUpLeg => l_thigh
    - segment: RightUpLeg => r_thigh
    - jointAngle: [r_thigh, l_thigh]
      export: Right Stride Angle
    - eventMask: [$prev, RFS, RFS]
      output: angle
    - max: angle.x

# Steps/min
# 60 / ((left mean step time + right mean step time) / 2)
- parameter: Steps_Per_Minute_Mean
  where:
    name: ^(Running|Gait)*
  steps:
  - eventDuration: [RFS, LFS]
    export: Left_Step_Time
  - eventDuration: [LFS, RFS]
    export: Right_Step_Time
  - mean: Left_Step_Time => Left_Step_Time_mean
  - divide: [60, Left_Step_Time_mean]
    export: Left_Steps_Per_Minute_Mean
  - mean: Right_Step_Time => Right_Step_Time_mean
  - divide: [60, Right_Step_Time_mean]
    export: Right_Steps_Per_Minute_Mean
  - concatenate: [Left_Steps_Per_Minute_Mean, Right_Steps_Per_Minute_Mean]
  - mean:

# Step length
- parameter: Right_Step_Length_Mean_treadmill
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - segment: RightFoot => r_foot
      space: VirtualLab
    - subtract: [r_foot.y@RFS, l_foot.y@LFS]
      frameSequenceOrder: reverse
    - convert:
      from: mm
      to: m
      output: Step_Length
    - multiply: [actual_running_speed_ms, Right_Step_Time]
      output: belt_shift
    - add: [Step_Length, belt_shift]

- parameter: Right_Step_Length_Mean_overground
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - segment: RightFoot => r_foot
      space: VirtualLab
    - subtract: [r_foot.y@RFS, l_foot.y@LFS]
      frameSequenceOrder: reverse
    - convert:
      from: mm
      to: m

- parameter: Left_Step_Length_Mean_treadmill
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - segment: RightFoot => r_foot
      space: VirtualLab
    - subtract: [l_foot.y@LFS, r_foot.y@RFS]
      frameSequenceOrder: reverse
    - convert:
      from: mm
      to: m
      output: Step_Length
    - multiply: [actual_running_speed_ms, Left_Step_Time]
      output: belt_shift
    - add: [Step_Length, belt_shift]

- parameter: Left_Step_Length_Mean_overground
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - segment: RightFoot => r_foot
      space: VirtualLab
    - subtract: [l_foot.y@LFS, r_foot.y@RFS]
      frameSequenceOrder: reverse
    - convert:
      from: mm
      to: m

- parameter: Right_Step_Length_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - if: Pelvis_COG_range > 1
      then: Right_Step_Length_Mean_overground
      else: Right_Step_Length_Mean_treadmill
      export: Right_Step_Length # for FA Running

- parameter: Left_Step_Length_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - if: Pelvis_COG_range > 1
      then: Left_Step_Length_Mean_overground
      else: Left_Step_Length_Mean_treadmill
      export: Left_Step_Length # for FA Running

- parameter: Step_Length_Mean_MEAN
  where:
    name: ^(Running|Gait)*
  steps:
    - concatenate: [Right_Step_Length_Mean, Left_Step_Length_Mean]
    - mean:

# Stride length
- parameter: Right_Stride_Length_Mean_treadmill
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot => foot
      space: VirtualLab
    - eventDuration: [RFS, RFS]
      export: right_stride_time
    - diff: foot.y@RFS
    - convert:
      from: mm
      to: m
      output: strideLength
    - multiply: [actual_running_speed_ms, right_stride_time]
      output: belt_shift
    - add: [strideLength, belt_shift]

- parameter: Right_Stride_Length_Mean_overground
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot => foot
      space: VirtualLab
    - eventDuration: [RFS, RFS]
      export: right_stride_time
    - diff: foot.y@RFS
    - convert:
      from: mm
      to: m

- parameter: Left_Stride_Length_Mean_treadmill
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => foot
      space: VirtualLab
    - eventDuration: [LFS, LFS]
      export: left_stride_time
    - diff: foot.y@LFS
    - convert:
      from: mm
      to: m
      output: strideLength
    - multiply: [actual_running_speed_ms, left_stride_time]
      output: belt_shift
    - add: [strideLength, belt_shift]

- parameter: Left_Stride_Length_Mean_overground
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => foot
      space: VirtualLab
    - eventDuration: [LFS, LFS]
      export: left_stride_time
    - diff: foot.y@LFS
    - convert:
      from: mm
      to: m

- parameter: Right_Stride_Length_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - if: Pelvis_COG_range > 1
      then: Right_Stride_Length_Mean_overground
      else: Right_Stride_Length_Mean_treadmill
      export: Right_Stride_Length # for FA Running

- parameter: Left_Stride_Length_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - if: Pelvis_COG_range > 1
      then: Left_Stride_Length_Mean_overground
      else: Left_Stride_Length_Mean_treadmill
      export: Left_Stride_Length # for FA Running

- parameter: Stride_Length_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - concatenate: [Right_Stride_Length_Mean, Left_Stride_Length_Mean]
    - mean:
      export: Stride_Length # for FA Running

# Stride width
# note V3D script is calculating it using stride vector
- parameter: Right_Stride_Width_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - segment: RightFoot => r_foot
      space: VirtualLab
    - subtract: [r_foot.x@RFS, l_foot.x@LFS]
      frameSequenceOrder: reverse
    - abs:

- parameter: Left_Stride_Width_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - segment: RightFoot => r_foot
      space: VirtualLab
    - subtract: [l_foot.x@LFS, r_foot.x@RFS]
      frameSequenceOrder: reverse
    - abs:

- parameter: Stride_Width_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - concatenate: [Right_Stride_Width_Mean, Left_Stride_Width_Mean]
    - mean:
    - convert:
      from: mm
      to: m
      export: Stride_Width # for FA Running

# Cycle time # for FA Running
- parameter: Cycle_Time
  where:
    name: ^(Running|Gait)*
  steps:
    - divide: [Left_Stride_Length_Mean, left_stride_time]
      output: left
    - divide: [Right_Stride_Length_Mean, right_stride_time]
      output: right
    - concatenate: [left, right]
    - mean:

# Stance time # for FA Running
- parameter: Left_Stance_Time
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [LFS, LTO]
    
- parameter: Right_Stance_Time
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [RFS, RTO]

# Swing time # for FA Running
- parameter: Left_Swing_Time
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [LTO, LFS]

- parameter: Right_Swing_Time
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [RTO, RFS]

# Strides per minute
- parameter: Left_Strides_Per_Minute_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - divide: [60, left_stride_time]
    - mean:

- parameter: Right_Strides_Per_Minute_Mean
  where:
    name: ^(Running|Gait)*
  steps:
    - divide: [60, right_stride_time]
    - mean:

# Vertical pelvis movement
- parameter: Pelvis_Height_RANGE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Hips, LFS, RFS]
      output: mask
    - max: mask.z => max
    - min: mask.z => min
    - subtract: [max, min]
    - convert:
      from: mm
      to: m

# Contact time
- parameter: Stance_Time_Mean_MEAN
  where:
    name: ^(Running|Gait)*
  steps:
  - eventDuration: [LFS, LTO]
    export: Left_Stance_Time_Mean
  - eventDuration: [RFS, RTO]
    export: Right_Stance_Time_Mean
  - mean: Left_Stance_Time_Mean => left_contact_time_mean
  - mean: Right_Stance_Time_Mean => right_contact_time_mean
  - concatenate: [left_contact_time_mean, right_contact_time_mean]
  - mean:

# Flight time
- parameter: Flight_Time_Mean_MEAN
  where:
    name: Running*
  steps:
  - eventDuration: [LTO, RFS]
    export: Flight_time_LTO_RFS
  - eventDuration: [RTO, LFS]
    export: Flight_time_RTO_LFS
  - mean: Flight_time_LTO_RFS => left_flight_time_mean
  - mean: Flight_time_RTO_LFS => right_flight_time_mean
  - concatenate: [left_flight_time_mean, right_flight_time_mean]
  - mean:

# Flight time/contact time ratio
- parameter: Swing_Contact_Ratio
  where:
    name: Running*
  steps:
  - divide: [Flight_Time_Mean_MEAN, Stance_Time_Mean_MEAN]

- parameter: Left_Swing_Contact_Ratio
  where:
    name: Running*
  steps:
  - divide: [Flight_time_LTO_RFS, Left_Stance_Time_Mean]

- parameter: Right_Swing_Contact_Ratio
  where:
    name: Running*
  steps:
  - divide: [Flight_time_RTO_LFS, Right_Stance_Time_Mean]

# Foot position at FS
- parameter: Left_HEEL_PELVIS_MEAN_X
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => l_foot
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [l_foot.y, pelvis.y]
    - convert:
      from: mm
      to: m
      output: heel_pelvis
    - import: heel_pelvis@LFS
      export: LHEEL_PELVIS_X 
    - mean: heel_pelvis@LFS

- parameter: Right_HEEL_PELVIS_MEAN_X
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot => r_foot
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [r_foot.y, pelvis.y]
    - convert:
      from: mm
      to: m
      output: heel_pelvis
    - import: heel_pelvis@RFS
      export: RHEEL_PELVIS_X 
    - mean: heel_pelvis@RFS

# Number of steps
- parameter: Cycle_Time_Count
  where:
    name: ^(Running|Gait)*
  steps:
  - eventDuration: [LFS, RFS]
  - count: $prev => l_to_r_count
  - eventDuration: [RFS, LFS]
  - count: $prev => r_to_l_count
  - add: [l_to_r_count, r_to_l_count]

# --- Pelvis angles ---
# at FS
- parameter: Left Pelvic Angles@LFS
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Pelvic Angles@LFS

- parameter: Right Pelvic Angles@RFS
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Pelvic Angles@RFS

# max during stance
- parameter: Left Pelvic Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Pelvic Angles, LFS, LTO]
      truncate: true
    - max:

- parameter: Right Pelvic Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Pelvic Angles, RFS, RTO]
      truncate: true
    - max:

# min during stance
- parameter: Left Pelvic Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Pelvic Angles, LFS, LTO]
      truncate: true
    - min:

- parameter: Right Pelvic Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Pelvic Angles, RFS, RTO]
      truncate: true
    - min:

# max during stride
- parameter: Left Pelvic Angles_MAX_stride
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Pelvic Angles, LFS, LFS]
      truncate: true
    - max:

- parameter: Right Pelvic Angles_MAX_stride
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Pelvic Angles, RFS, RFS]
      truncate: true
    - max:

# --- Hip angles ---
# at FS
- parameter: L_HIP_ANGLE@LFS
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Hip Angles@LFS

- parameter: R_HIP_ANGLE@RFS
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Hip Angles@RFS

# max during stance
- parameter: Left Hip Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Hip Angles, LFS, LTO]
      truncate: true
    - max:

- parameter: Right Hip Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Hip Angles, RFS, RTO]
      truncate: true
    - max:

# min during stance
- parameter: Left Hip Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Hip Angles, LFS, LTO]
      truncate: true
    - min:

- parameter: Right Hip Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Hip Angles, RFS, RTO]
      truncate: true
    - min:

# max during stride
- parameter: Left Hip Angles_MAX_stride
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Hip Angles, LFS, LFS]
      truncate: true
    - max:

- parameter: Right Hip Angles_MAX_stride
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Hip Angles, RFS, RFS]
      truncate: true
    - max:

# --- Knee angles ---
# at FS
- parameter: L_KNEE_ANG@LFS
  set: left
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Knee Angles@LFS

- parameter: R_KNEE_ANG@RFS
  set: right
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Knee Angles@RFS

# max during stance
- parameter: Left Knee Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Knee Angles, LFS, LTO]
      truncate: true
    - max:

- parameter: Right Knee Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Knee Angles, RFS, RTO]
      truncate: true
    - max:

# min during stance
- parameter: Left Knee Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Knee Angles, LFS, LTO]
      truncate: true
    - min:

- parameter: Right Knee Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Knee Angles, RFS, RTO]
      truncate: true
    - min:

# max during stride
- parameter: Left Knee Angles_MAX
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Knee Angles, LFS, LFS]
      truncate: true
    - max:

- parameter: Right Knee Angles_MAX
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Knee Angles, RFS, RFS]
      truncate: true
    - max:

# --- Ankle angles ---
# max during stance
- parameter: Left Ankle Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Ankle Angles, LFS, LTO]
      truncate: true
    - max:

- parameter: Right Ankle Angles_MAX_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Ankle Angles, RFS, RTO]
      truncate: true
    - max:

# min during stance
- parameter: Left Ankle Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Ankle Angles, LFS, LTO]
      truncate: true
    - min:

- parameter: Right Ankle Angles_MIN_stance
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Ankle Angles, RFS, RTO]
      truncate: true
    - min:

# Foot wrt lab at footstrike
- parameter: L_FOOT_CONTACT_ANGLE@LFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Foot Contact Angle_shifted@LFS

- parameter: R_FOOT_CONTACT_ANGLE@RFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Foot Contact Angle_shifted@RFS

# Time between max stride angle and max knee flexion
- parameter: L_PEAK_KNEE_ANGLE_to_Left Stride Angle_max
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [L_peak_knee_flex, L_stride_angle_max]

- parameter: R_PEAK_KNEE_ANGLE_to_Right Stride Angle_max
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [R_peak_knee_flex, R_stride_angle_max]

# Time from max hip flexion to footstrike
- parameter: L_peak_hip_flexion_cycle_to_LFS_L_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [L_peak_hip_flex, LFS]

- parameter: R_peak_hip_flexion_cycle_to_RFS_R_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [R_peak_hip_flex, RFS]

# Time from max knee flexion to ankle cross
- parameter: L_PEAK_KNEE_ANGLE_to_L_Ankle_cross_L_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [L_peak_knee_flex, L_Ankle_cross]

- parameter: R_PEAK_KNEE_ANGLE_to_R_Ankle_cross_R_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [R_peak_knee_flex, R_Ankle_cross]

# Time from toe off to max hip flexion
- parameter: LTO_to_L_peak_hip_flexion_L_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [LTO, L_peak_hip_flex]

- parameter: RTO_to_R_peak_hip_flexion_R_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [RTO, R_peak_hip_flex]

# Time from toe off to hip flexion initiation
- parameter: LTO_to_L_peak_hip_extension_stride_L_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [LTO, L_peak_hip_extension_stride]

- parameter: RTO_to_R_peak_hip_extension_stride_R_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [RTO, R_peak_hip_extension_stride]

# Time from toe off to knee flexion initiation
- parameter: LTO_to_L_peak_knee_extension_stride_L_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [LTO, L_peak_knee_extension_stride]

- parameter: RTO_to_R_peak_knee_extension_stride_R_CYCLE
  where:
    name: ^(Running|Gait)*
  steps:
    - eventDuration: [RTO, R_peak_knee_extension_stride]

# Hip max extension per stride
- parameter: Left Hip Angles_MIN_stride
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Left Hip Angles, LFS, LFS]
      truncate: true
    - min:

- parameter: Right Hip Angles_MIN_stride
  where:
    name: ^(Running|Gait)*
  steps:
    - eventMask: [Right Hip Angles, RFS, RFS]
      truncate: true
    - min:

# Hip angular velocity at footstrike
- parameter: Left Hip Angles_Velocity
  where:
    name: ^(Running|Gait)*
  steps:
    - lowpass: Left Hip Angles
      extrapolate: 100
      order: 6
      cutoff: 12
    - velocity:

- parameter: Right Hip Angles_Velocity
  where:
    name: ^(Running|Gait)*
  steps:
    - lowpass: Right Hip Angles
      extrapolate: 100
      order: 6
      cutoff: 12
    - velocity:

- parameter: Left Hip Angles_Velocity@LFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Hip Angles_Velocity@LFS

- parameter: Right Hip Angles_Velocity@RFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Hip Angles_Velocity@RFS

# Hip angular velocity at midstance
- parameter: Left Hip Angles_Velocity@L_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Hip Angles_Velocity@L_MID_STANCE

- parameter: Right Hip Angles_Velocity@R_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Hip Angles_Velocity@R_MID_STANCE

# Hip angular velocity at toe off
- parameter: Left Hip Angles_Velocity@LTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Hip Angles_Velocity@LTO

- parameter: Right Hip Angles_Velocity@RTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Hip Angles_Velocity@RTO

# Hip angular velocity at ankle cross
- parameter: Left Hip Angles_Velocity@L_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Hip Angles_Velocity@L_Ankle_cross

- parameter: Right Hip Angles_Velocity@R_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Hip Angles_Velocity@R_Ankle_cross

# Hip flexion angular velocity (slope)
#/EXPRESSION=(METRIC::MAX::&::side& Hip Angles@&::side_short&_peak_hip_flexion_cycle_&::side_short&_CYCLE - METRIC::TOEOFF::&::side& Hip Angles@&::side_short&TO_&::side_short&_CYCLE) / METRIC::TIMING::&::side_short&TO_to_&::side_short&_peak_hip_flexion_&::side_short&_CYCLE
#(Left Hip Angles_MAX_stance - Left Hip Angles@LTO) / LTO_to_L_peak_hip_flexion_L_CYCLE
- parameter: Left_hip_ang_vel_slope
  where:
    name: ^(Running|Gait)*
  steps:
    - subtract: [Left Hip Angles_MAX_stance.x, Left Hip Angles.x@LTO]
    - divide: [$prev, LTO_to_L_peak_hip_flexion_L_CYCLE]

- parameter: Right_hip_ang_vel_slope
  where:
    name: ^(Running|Gait)*
  steps:
    - subtract: [Right Hip Angles_MAX_stance.x, Right Hip Angles.x@RTO]
    - divide: [$prev, RTO_to_R_peak_hip_flexion_R_CYCLE]

# Thigh angle at max stride angle
- parameter: Left Thigh Angles
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: [LeftUpLeg]
      space: VirtualLab
    - multiply: [$prev, [1, -1,-1]]

- parameter: Right Thigh Angles
  where:
    name: ^(Running|Gait)*
  steps:
    - jointAngle: [RightUpLeg]
      space: VirtualLab

- parameter: Left Thigh Angles@Left Stride Angle_max
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Thigh Angles@L_stride_angle_max
  
- parameter: Right Thigh Angles@Right Stride Angle_max
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Thigh Angles@R_stride_angle_max
  
  # Thigh angle at max knee flexion
- parameter: Left Thigh Angles@L_peak_knee_flexion
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Thigh Angles@L_peak_knee_flex

- parameter: Right Thigh Angles@R_peak_knee_flexion
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Thigh Angles@R_peak_knee_flex

# Knee to knee separation distance at mistance
- parameter: Knees_distance_left_stride@L_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftLeg => l_knee
      space: VirtualLab
    - segment: RightLeg => r_knee
      space: VirtualLab
    - subtract: [r_knee, l_knee]
    - convert:
      from: mm
      to: m
      output: knee_dist
    - import: knee_dist@L_MID_STANCE

- parameter: Knees_distance_right_stride@R_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftLeg => l_knee
      space: VirtualLab
    - segment: RightLeg => r_knee
      space: VirtualLab
    - subtract: [l_knee, r_knee]
    - convert:
      from: mm
      to: m
      output: knee_dist
    - import: knee_dist@R_MID_STANCE

# Knee flexion at toe off
- parameter: Left Knee Angles@LTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Knee Angles@LTO

- parameter: Right Knee Angles@RTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Knee Angles@RTO

# Knee flexion at ankle cross
- parameter: Left Knee Angles@L_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Knee Angles@L_Ankle_cross

- parameter: Right Knee Angles@R_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Knee Angles@R_Ankle_cross

# Knee angular velocity at footstrike
- parameter: Left Knee Angles_Velocity@LFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Knee Angles_Velocity@LFS
  
- parameter: Right Knee Angles_Velocity@RFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Knee Angles_Velocity@RFS
  
# Knee angular velocity at midstance
- parameter: Left Knee Angles_Velocity@L_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Knee Angles_Velocity@L_MID_STANCE
  
- parameter: Right Knee Angles_Velocity@R_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Knee Angles_Velocity@R_MID_STANCE
  
# Knee angular velocity at toe off
- parameter: Left Knee Angles_Velocity@LTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Knee Angles_Velocity@LTO
  
- parameter: Right Knee Angles_Velocity@RTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Knee Angles_Velocity@RTO
  
# Knee angular velocity at ankle cross
- parameter: Left Knee Angles_Velocity@L_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Knee Angles_Velocity@L_Ankle_cross
  
- parameter: Right Knee Angles_Velocity@R_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Knee Angles_Velocity@R_Ankle_cross

# Shank angular velocity at footstrike
- parameter: Left Shank wrt VLab Ang Vel@LFS
  where:
    name: ^(Running|Gait)*
  steps:
    - angularVelocity: [VirtualLabSegment, LeftLeg, VirtualLabSegment, LeftLeg]
    - lowpass:
      cutoff: 10
      extrapolate: 5
    - multiply: [$prev, [1, -1, -1]]
      output: leg_ang_vel
    - import: leg_ang_vel@LFS

- parameter: Right Shank wrt VLab Ang Vel@RFS
  where:
    name: ^(Running|Gait)*
  steps:
    - angularVelocity: [VirtualLabSegment, RightLeg, VirtualLabSegment, RightLeg]
    - lowpass:
      cutoff: 10
      extrapolate: 5
      output: leg_ang_vel
    - import: leg_ang_vel@RFS

# Shank angular velocity at ankle cross
- parameter: Left Shank wrt VLab Ang Vel@L_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - angularVelocity: [VirtualLabSegment, LeftLeg, VirtualLabSegment, LeftLeg]
    - lowpass:
      cutoff: 10
      extrapolate: 5
    - multiply: [$prev, [1, -1, -1]]
      output: leg_ang_vel
    - import: leg_ang_vel@L_Ankle_cross

- parameter: Right Shank wrt VLab Ang Vel@R_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - angularVelocity: [VirtualLabSegment, RightLeg, VirtualLabSegment, RightLeg]
    - lowpass:
      cutoff: 10
      extrapolate: 5
      output: leg_ang_vel
    - import: leg_ang_vel@R_Ankle_cross

# Ankle angular velocity at footstrike
- parameter: Left Ankle Angles_Velocity@LFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Ankle Angles_Velocity@LFS

- parameter: Right Ankle Angles_Velocity@RFS
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Ankle Angles_Velocity@RFS

# Ankle angular velocity at midstance
- parameter: Left Ankle Angles_Velocity@L_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Ankle Angles_Velocity@L_MID_STANCE

- parameter: Right Ankle Angles_Velocity@R_MID_STANCE
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Ankle Angles_Velocity@R_MID_STANCE

# Ankle angular velocity at toe off
- parameter: Left Ankle Angles_Velocity@LTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Ankle Angles_Velocity@LTO

- parameter: Right Ankle Angles_Velocity@RTO
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Ankle Angles_Velocity@RTO

# Ankle angular velocity at ankle cross
- parameter: Left Ankle Angles_Velocity@L_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Left Ankle Angles_Velocity@L_Ankle_cross

- parameter: Right Ankle Angles_Velocity@R_Ankle_cross
  where:
    name: ^(Running|Gait)*
  steps:
    - import: Right Ankle Angles_Velocity@R_Ankle_cross

# Foot distance to body COG at footstrike
# using pelvis origin instead of body COG
- parameter: Left_Foot_Distance_to_body_COG@LFS
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: LeftFoot => foot
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [foot, pelvis]
    - convert:
      from: mm
      to: m
      output: foot_pelvis_dist
    - import: foot_pelvis_dist@LFS

- parameter: Right_Foot_Distance_to_body_COG@RFS
  where:
    name: ^(Running|Gait)*
  steps:
    - segment: RightFoot => foot
      space: VirtualLab
    - segment: Hips => pelvis
      space: VirtualLab
    - subtract: [foot, pelvis]
    - convert:
      from: mm
      to: m
      output: foot_pelvis_dist
    - import: foot_pelvis_dist@RFS
