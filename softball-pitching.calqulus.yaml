- template: templates/skeleton-mapping.calqulus.yaml

############
## SPACES ##
############

# Calculated from respective position of feet at Release
# Assuming Release is entered manually in QTM for now

- parameter: Feet_unit_vector
  where: 
    name: Pitching*
  steps:
    - subtract: [LeadForefoot2@Release, BackForefoot2@Release]
    - convert:
      from: mm
      to: m
    - unitVector:
    - round:

- space: VirtualLab
  origin: [0,0,0]
  primaryAxis: [Feet_unit_vector?name=Pitching*]
  secondaryAxis: [[0,0,0], [0,0,1]]
  order: yz

- parameter: VirtualLabOrigin
  steps:
    - segment: RightToeBase
    - multiply: [$prev, 0]

- segment: VirtualLabSegment
  steps:
    - segment:
      origin: VirtualLabOrigin
      primaryAxis: Feet_unit_vector?name=Pitching*
      secondaryAxis: [[0,0,0], [0,0,1]]
      order: yz  

############
## EVENTS ##
############

- template: /templates/events-kinetics.calqulus.yaml
  where:
    force: any

- event: EOF
  where: 
    name: Pitching*
  steps:
    - subtract: [$length, 1]

- event: PLOTSTART_SETUP
  where: 
    name: Pitching*
  steps:
    - import: Setup

- event: PLOTSTART_Footstrike
  where: 
    name: Pitching*
  steps:
    - import: Lead_Leg_Footstrike

- event: PLOTSTART_MaxKneeHeight
  where: 
    name: Pitching*
  steps:
    - import: MaxKneeHeight

- event: PLOTEND
  where: 
    name: Pitching*
  steps:
    - import: Release100msAfter

- event: MaxKneeHeight
  where: 
    name: Pitching*
  steps:
    - max: LeadShank.z
      frames: true

- event: MaxKneeHeight_30
  where: 
    name: Pitching*
  steps:
    - import: MaxKneeHeight
    - subtract: [ $prev, 30 ]

- event: Setup
  where: 
    name: Pitching*
  steps:
    - velocity: PitchingHand.z
    - subtract: [$prev, $prev@2]
    - threshold:
      value: -0.2
      direction: down
    - eventMask: [$prev, 1, MaxKneeHeight]
    - import: $prev@1  #first instance

- event: Lead_Leg_Footstrike_kinematics
  where: 
    name: Pitching*
  steps:
    - velocity: LeadFoot.z
    - subtract: [$prev, $prev@2]
    - threshold:
      value: -0.1
      direction: up
    - eventMask: [$prev, MaxKneeHeight, EOF]
    - import: $prev@1  #first instance

- event: Back_Leg_Footoff_kinematics
  where: 
    name: Pitching*
  steps:
    - velocity: BackFoot
    - eventMask: [$prev, MaxKneeHeight_30, Lead_Leg_Footstrike]
    - max: $prev.z
      frames: true
    
- event: Lead_Leg_Footstrike_kinetics
  where: 
    name: Pitching*
    force: any
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LON_force
      else: RON_force

- event:  Back_Leg_Footoff_kinetics
  where: 
    name: Pitching*
    force: any
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: ROFF_force
      else: LOFF_force

- event: Lead_Leg_Footstrike
  where: 
    name: Pitching*
  steps:
    - if: exists(Lead_Leg_Footstrike_kinetics)
      then: Lead_Leg_Footstrike_kinetics
      else: Lead_Leg_Footstrike_kinematics

- event: Back_Leg_Footoff
  where: 
    name: Pitching*
  steps:
    - if: exists(Back_Leg_Footoff_kinetics)
      then: Back_Leg_Footoff_kinetics
      else: Back_Leg_Footoff_kinematics

- event: Lead_Leg_Footstrike_20
  where: 
    name: Pitching*
  steps:
    - import: Lead_Leg_Footstrike
    - multiply: [$framerate, 0.2]
    - subtract: [$prev(2), $prev]

- event: Backswing_Top
  where: 
    name: Pitching*
  steps:
    - import: PitchingHand
    - eventMask: [$prev, 1, Lead_Leg_Footstrike]
    - max: $prev.z
      frames: true
    
- event: Release100msAfter
  where: 
    name: Pitching*
  steps:
    - divide: [$framerate, 10] 
    - add: [Release, $prev] # use '0.1s' after available

- event: Max_Pelvis_Ang_Vel_ev
  where: 
    name: Pitching*
  steps:
    - import: Pelvis_Ang_Vel
    - eventMask: [$prev.z, Setup, Release100msAfter]
    - max: $prev
      frames: true

- event: Max_Thorax_Ang_Vel_ev
  where: 
    name: Pitching*
  steps:
    - import: Thorax_Ang_Vel
    - eventMask: [$prev.z, Setup, Release100msAfter]
    - max: $prev
      frames: true

- event: Max_Pitching_Elbow_Ang_Vel_ev
  where: 
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Ang_Vel
    - eventMask: [$prev.x, Setup, Release100msAfter]
    - max: $prev
      frames: true

- event: Max_Pitching_Hand_Ang_Vel_ev
  where: 
    name: Pitching*
  steps:
    - import: Pitching_Hand_Ang_Vel
    - eventMask: [$prev.y, Setup, Release100msAfter]
    - max: $prev
      frames: true

############
## SERIES ##
############

- template: /templates/timeseries.calqulus.yaml

# Kinematics ---------------

# find out which max hand linear velocity magnitude is higher
- parameter: Left_Hand_Vel_max
  where: 
    name: Pitching*
  steps:
    - velocity: LeftHand
    - magnitude:
    - max:

- parameter: Right_Hand_Vel_max
  where: 
    name: Pitching*
  steps:
    - velocity: RightHand
    - magnitude:
    - max:

# define body side
- parameter: PitchingShoulder
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightShoulder
      else: LeftShoulder

- parameter: PitchingArm
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightArm
      else: LeftArm

- parameter: PitchingForearm
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightForearm
      else: LeftForearm

- parameter: PitchingHand
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightHand
      else: LeftHand

- parameter: GloveShoulder
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftShoulder
      else: RightShoulder

- parameter: GloveArm
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftArm
      else: RightArm

- parameter: GloveForearm
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftForearm
      else: RightForearm

- parameter: LeadThigh
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftUpLeg
      else: RightUpLeg

- parameter: LeadShank
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftLeg
      else: RightLeg

- parameter: LeadFoot
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftFoot
      else: RightFoot

- parameter: BackThigh
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightUpLeg
      else: LeftUpLeg

- parameter: BackShank
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightLeg
      else: LeftLeg

- parameter: BackFoot
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightFoot
      else: LeftFoot

- parameter: BackToeBase
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightToeBase
      else: LeftToeBase

- parameter: LeftForefoot
  where: 
    name: Pitching*
  steps:
    - if: exists(LForefoot2)
      then: LForefoot2
      else: LeftToeBase
    - vector: [$prev.x, $prev.y, $prev.z]
      
- parameter: RightForefoot
  where: 
    name: Pitching*
  steps:
    - if: exists(RForefoot2)
      then: RForefoot2
      else: RightToeBase
    - vector: [$prev.x, $prev.y, $prev.z]
      
- parameter: LeadForefoot2
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftForefoot
      else: RightForefoot

- parameter: BackForefoot2
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: RightToeBase
      else: LeftToeBase

- parameter: LeftHeelBack
  where: 
    name: Pitching*
  steps:
    - if: exists(LHeelBack)
      then: LHeelBack
      else: LeftAnkle
    - vector: [$prev.x, $prev.y, $prev.z]

- parameter: RightHeelBack
  where: 
    name: Pitching*
  steps:
    - if: exists(RHeelBack)
      then: RHeelBack
      else: RightAnkle
    - vector: [$prev.x, $prev.y, $prev.z]

- parameter: LeadHeelBack
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftHeelBack
      else: RightHeelBack

# Set side conventions
- parameter: Pitching_Shoulder_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, -1, -1]]
      else: [[-1, 1, 1]]

- parameter: Glove_Shoulder_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, 1, 1]]
      else: [[1, -1, -1]]

- parameter: Hand_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, -1, 1]]
      else: [[1, -1, 1]]

- parameter: Knee_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, 1]]
      else: [[-1, 1, 1]]

- parameter: Foot_wrt_Lab_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, 1, 1]]
      else: [[1, 1, -1]]

- parameter: Hip_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, -1, -1]]
      else: [[1, -1, -1]]

- parameter: Hip_Shoulder_Sep_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, -1]]
      else: [[-1, 1, 1]]

- parameter: Trunk_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, -1]]
      else: [[-1, 1, 1]]

- parameter: Trunk_Ang_Vel_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, 1]]
      else: [[-1, -1, -1]]
  
- parameter: Trunk_wrt_Pelvis_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, -1]]
      else: [[-1, 1, 1]]

- parameter: Pelvis_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, -1]]
      else: [[-1, 1, 1]]

- parameter: Pelvis_Ang_Vel_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, 1]]
      else: [[-1, 1, -1]]
  
- parameter: Ankle_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, -1, -1]]
      else: [[1, -1, -1]]

- parameter: Elbow_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, -1, -1]]
      else: [[1, 1, 1]]

- parameter: Pitching_Humerus_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, 1, 1]]
      else: [[1, 1, -1]]

- parameter: COG_Vel_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[1, 1, 1]]
      else: [[1, 1, 1]]

- parameter: Head_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, 1, -1]]
      else: [[1, 1, 1]]

- parameter: Head_Ang_Vel_Convention
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: [[-1, -1, 1]]
      else: [[1, -1, -1]]
  
# Pitching Hand Angle
- parameter: Pitching_Hand_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [PitchingForearm, PitchingHand]
    - multiply: [$prev, Hand_Convention]

# Pitching hand ang vel
- parameter: Pitching_Hand_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [VirtualLabSegment, PitchingHand, VirtualLabSegment, PitchingHand]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Hand_Convention]

- parameter: Pitching_Elbow_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [PitchingArm, PitchingForearm]
    - multiply: [$prev, Elbow_Convention]

- parameter: Pitching_Elbow_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [PitchingArm, PitchingForearm, PitchingArm, PitchingForearm]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Elbow_Convention]

# Pitching Shoulder angle
- parameter: Pitching_Shoulder_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [Spine2, PitchingArm]
      rotationOrder: ZYZ
      unwrap: true
    - multiply: [$prev, Pitching_Shoulder_Convention]

- parameter: Pitching_Shoulder_Angle_XYZ
  where: 
    name: Pitching*
  steps:
    - angle: [Spine2, PitchingArm]
    - multiply: [$prev, Pitching_Shoulder_Convention]

# Pitching Shoulder angular velocity
- parameter: Pitching_Shoulder_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [PitchingShoulder, PitchingArm, Spine2, PitchingArm]
      useRotationOrder: true
      rotationOrder: ZYZ
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Pitching_Shoulder_Convention]

# Pitching Shoulder Ang Vel Horizontal Shoulder Abduction
- parameter: Pitching_Shoulder_AngVel_HzShldAbd
  where: 
    name: Pitching*
  steps:
    - velocity: Pitching_Shoulder_Angle

# Glove Shoulder Angle
- parameter: Glove_Shoulder_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [Spine2, GloveArm]
      rotationOrder: ZYZ
    - multiply: [$prev, Glove_Shoulder_Convention]

- parameter: Glove_Shoulder_Angle_XYZ
  where: 
    name: Pitching*
  steps:
    - angle: [Spine2, GloveArm]
      rotationOrder: XYZ
    - multiply: [$prev, Glove_Shoulder_Convention]

# Glove Elbow Angle
- parameter: Glove_Elbow_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [GloveArm, GloveForearm]
    - multiply: [$prev, Elbow_Convention]

# Glove Shoulder Ang Vel
- parameter: Glove_Shoulder_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [GloveShoulder, GloveArm, Spine2, GloveArm]
      useRotationOrder: true
      rotationOrder: ZYZ
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Glove_Shoulder_Convention]

# Lead Hip Angle
- parameter: Lead_Hip_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [Hips, LeadThigh]
    - multiply: [$prev, Hip_Convention]

# Lead Hip Ang Vel
- parameter: Lead_Hip_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [Hips, LeadThigh, Hips, LeadThigh]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Hip_Convention]

# Lead Knee Angle
- parameter: Lead_Knee_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [LeadThigh, LeadShank]
    - multiply: [$prev, Knee_Convention]

# Lead Knee Ang Vel
- parameter: Lead_Knee_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [LeadThigh, LeadShank, LeadThigh, LeadShank]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Knee_Convention]

# Lead Ankle Angle
- parameter: Lead_Ankle_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [LeadShank, LeadFoot]
    - multiply: [$prev, Ankle_Convention]

# Lead Ankle Ang Vel
- parameter: Lead_Ankle_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [LeadShank, LeadFoot, LeadShank, LeadFoot]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Ankle_Convention]

# Back Hip Angle
- parameter: Back_Hip_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [Hips, BackThigh]
    - multiply: [$prev, Hip_Convention]

# Back Hip Ang Vel
- parameter: Back_Hip_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [Hips, BackThigh, Hips, BackThigh]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Hip_Convention]

# Back Knee Angle
- parameter: Back_Knee_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [BackThigh, BackShank]
    - multiply: [$prev, Knee_Convention]

# Back Knee Ang Vel
- parameter: Back_Knee_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [BackThigh, BackShank, BackThigh, BackShank]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Knee_Convention]

# Back Ankle Angle
- parameter: Back_Ankle_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [BackShank, BackFoot]
    - multiply: [$prev, Ankle_Convention]

# Back Ankle Ang Vel
- parameter: Back_Ankle_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [BackShank, BackFoot, BackShank, BackFoot]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Ankle_Convention]

# Trunk wrt Pelvis Angle
- parameter: Trunk_wrt_Pelvis_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [Hips, Spine2]
    - multiply: [$prev, Trunk_wrt_Pelvis_Convention]

# Trunk angle
- parameter: Trunk_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [Spine2]
      space: VirtualLab
    - multiply: [$prev, Trunk_Convention]

# Trunk angular velocity
- parameter: Thorax_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [VirtualLabSegment, Spine2, VirtualLabSegment, Spine2]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Trunk_Ang_Vel_Convention]

# Pelvis angle
- parameter: Pelvis_Angle
  where: 
    name: Pitching*
  steps:
    - angle: [Hips]
      space: VirtualLab
    - multiply: [$prev, Pelvis_Convention]

# Pelvis angular velocity
- parameter: Pelvis_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [VirtualLabSegment, Hips, VirtualLabSegment, Hips]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Pelvis_Ang_Vel_Convention]

# Lead Foot wrt lab
- parameter: Lead_Foot_wrt_Lab
  where: 
    name: Pitching*
  steps:
    - angle: [LeadFoot]
      space: VirtualLab
    - multiply: [$prev, Foot_wrt_Lab_Convention]

# Back Foot wrt lab
- parameter: Back_Foot_wrt_Lab
  where: 
    name: Pitching*
  steps:
    - angle: [BackFoot]
      space: VirtualLab
    - multiply: [$prev, Foot_wrt_Lab_Convention]

# Pitching humerus ang vel
- parameter: Pitching_Humerus_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [VirtualLabSegment, PitchingArm, VirtualLabSegment, PitchingArm]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Pitching_Humerus_Convention]

# Hip Shoulders Separation
- parameter: Hip Shoulders Sep
  where: 
    name: Pitching*
  steps:
    - angle: [Hips, Spine2]
      rotationOrder: ZYX
    - multiply: [$prev, Hip_Shoulder_Sep_Convention]

- parameter: Trunk_COG_Vel_MPH # we do not have segment COG, so using origin instead
  where: 
    name: Pitching*
  steps:
    - convert: Spine2
      from: mm
      to: m
      space: VirtualLab
    - vector: [$prev.x,$prev.y,$prev.z]
    - multiply: [$prev, COG_Vel_Convention]
      export: Trunk_COG
    - velocity: $prev => speed
      export: Trunk_COG_Vel
    - convert: speed
      from: m/s
      to: ft/s
      export: Trunk_COG_Vel_Feet
    - convert: speed
      from: m/s
      to: mph
    #- multiply: [$prev, COG_Vel_Convention]

- parameter: Pelvis_COG_Vel_MPH # we do not have segment COG, so using origin instead
  where: 
    name: Pitching*
  steps:
    - convert: Hips
      from: mm
      to: m
      space: VirtualLab
    - vector: [$prev.x,$prev.y,$prev.z]
    - multiply: [$prev, COG_Vel_Convention]
      export: Pelvis_COG
    - velocity: $prev => speed
      export: Pelvis_COG_Vel
    - convert: speed
      from: m/s
      to: ft/s
      export: Pelvis_COG_Vel_Feet
    - convert: speed
      from: m/s
      to: mph
    #- multiply: [$prev, COG_Vel_Convention]

- parameter: Back_Foot_COG
  where: 
    name: Pitching*
  steps:
    - convert: BackToeBase
      from: mm
      to: m
      space: VirtualLab

- parameter: Head_Angle
  where: 
    name: Pitching*
  steps:
    - angle: Head
      space: VirtualLab
    - multiply: [$prev, Head_Convention]
 
- parameter: Head_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - angularVelocity: [VirtualLabSegment, Head, VirtualLabSegment, Head]
    - lowpass:
      cutoff: 24
      extrapolate: 5
    - multiply: [$prev, Head_Ang_Vel_Convention]

- parameter: Lead_KNEE_dyn
  where: 
    name: Pitching*
  steps:
    - import: LeadShank
      space: VirtualLab
    - convert: 
      from: mm
      to: m

- parameter: Back_Knee_dyn
  where: 
    name: Pitching*
  steps:
    - import: BackShank
      space: VirtualLab
    - convert: 
      from: mm
      to: m

- parameter: Max_RPV_CGPos_VLab_Linear_Vel
  where: 
    name: Pitching*
  steps:
    - magnitude: PelvisCGPos_vel
    - eventMask: [$prev, Setup, Release100msAfter]
    - max:

# Kinetics ----------------
# GRF
- parameter: Lead GRF_BW
  where: 
    name: Pitching*
    force: any
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: Left GRF
      else: Right GRF

- parameter: Trail GRF_BW
  where: 
    name: Pitching*
    force: any
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: Right GRF
      else: Left GRF

- parameter: Force_FS1_1_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - add: [Lead GRF_BW, Trail GRF_BW]

- parameter: Lead_Leg_GRF_mag
  where: 
    name: Pitching*
    force: any
  steps:
    - magnitude: Lead GRF_BW

- parameter: Back_Leg_GRF_mag
  where: 
    name: Pitching*
    force: any
  steps:
    - magnitude: Trail GRF_BW

# COM/COP
- parameter: LeadHeel
  where: 
    name: Pitching*
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftHeelBack
      else: RightHeelBack
    - convert:
      from: mm
      to: m

- parameter: COM wrt Lead Heel_plot
  where: 
    name: Pitching*
  steps:
    - vector: [Hips.x, Hips.y, Hips.z]
    - convert:
      from: mm
      to: m
    - import: LeadHeel@Release
    - subtract: [$prev(2), $prev]

- parameter: COM wrt Lead Heel
  where: 
    name: Pitching*
  steps:
    - vector: [Hips.x, Hips.y, Hips.z]
    - convert:
      from: mm
      to: m
    - import: LeadHeel@Release
    - subtract: [$prev(2), $prev]

- parameter: Left COP wrt Lead Heel_plot
  where: 
    name: Pitching*
    force: left
  steps:
    - import: LeadHeel@Release
    - subtract: [Left_COP, $prev]

- parameter: Right COP wrt Lead Heel_plot
  where: 
    name: Pitching*
    force: right
  steps:
    - import: LeadHeel@Release
    - subtract: [Right_COP, $prev]

- parameter: COM wrt Lead Heel_vel
  where: 
    name: Pitching*
  steps:
    - velocity: COM wrt Lead Heel
    - lowpass:
      cutoff: 12

- parameter: Left_Foot_wrt_Lead_Heel_plot
  where: 
    name: Pitching*
    force: both
  steps:
    - import: LeftHeelBack@Lead_Comm
      output: heel
    - import: LeftForefoot@Lead_Comm
      output: toe
    - concatenate: [heel, toe]
      output: foot
    - import: LeadHeelBack@Release
    - subtract: [foot, $prev]
    - convert:
      from: mm
      to: m

- parameter: Right_Foot_wrt_Lead_Heel_plot
  where: 
    name: Pitching*
    force: both
  steps:
    - import: RightHeelBack@Lead_Comm
      output: heel
    - import: RightForefoot@Lead_Comm
      output: toe
    - concatenate: [heel, toe]
      output: foot
    - import: LeadHeelBack@Release
    - subtract: [foot, $prev]
    - convert:
      from: mm
      to: m
      
- parameter: Pelvis_COG wrt Lead Heel_plot
  where: 
    name: Pitching*
  steps:
    - vector: [Hips.x, Hips.y, Hips.z]
    - convert:
      from: mm
      to: m
    - import: LeadHeel@Release
    - subtract: [$prev(2), $prev]

- parameter: Trunk_COG wrt Lead Heel_plot
  where: 
    name: Pitching*
  steps:
    - vector: [Spine1.x, Spine1.y, Spine1.z]
    - convert:
      from: mm
      to: m
    - import: LeadHeel@Release
    - subtract: [$prev(2), $prev]

# Combined COP - mean COP -----
# calculate combined COP
- parameter: Combined_COP
  where: 
    name: Pitching*
    force: both
  steps:
    - magnitude: Left GRF
      output: left_grf_mag
    - magnitude: Right GRF
      output: right_grf_mag

    - multiply: [Left_COP, [left_grf_mag, left_grf_mag, left_grf_mag]]
      output: l_temp
    - multiply: [Right_COP, [right_grf_mag, right_grf_mag, right_grf_mag]]
      output: r_temp

    - add: [l_temp, r_temp]
      output: temp_sum
    - add: [left_grf_mag, right_grf_mag]
      output: grf_sum
    - divide: [temp_sum, [grf_sum, grf_sum, grf_sum]]

# Merge combined COP with single leg COPs
# TO DO: we need a new merge step

# Normalize COP to Lead heel
- parameter: Combined COP wrt Lead Heel_plot
  where: 
    name: Pitching*
    force: both
  steps:
    - import: LeadHeel@Release
    - subtract: [Combined_COP, $prev]

- parameter: Combined COP wrt Lead Heel #for compatibility with layout
  where: 
    name: Pitching*
    force: both
  steps:
    - import: Combined COP wrt Lead Heel_plot

- parameter: Combined COP wrt Lead Heel_vel
  where: 
    name: Pitching*
    force: both
  steps:
    - velocity: Combined COP wrt Lead Heel

- parameter: LeadFootContact_mz
  where: 
    name: Pitching*
    force: both
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: LeftFootContact.mz
      else: RightFootContact.mz

# Moments ----
# Add upper body kinetics after it is added to the model
# - parameter: Shoulder Torque
#   where:
#     name: Pitching*
#     force: both
#   steps:
#     - if: Right_Hand_Vel_max > Left_Hand_Vel_max
#       then: LeftArm.mz
#       else: RightArm.mz
#     - divide: [$prev, $field(Weight; measurement; numeric)]

# Horizontal
- parameter: Left_Free_Moment_BW
  where: 
    name: Pitching*
    force: left
  steps:
    - multiply: [LeftFootContact.mz, 100]
    - divide: [$prev, BodyWeightNewton]

- parameter: Right_Free_Moment_BW
  where: 
    name: Pitching*
    force: right
  steps:
    - multiply: [RightFootContact.mz, 100]
    - divide: [$prev, BodyWeightNewton]

- parameter: Left AP Force Torque COM_BW
  where: 
    name: Pitching*
    force: left
  steps:
    - import: LeftFootContact.x
    - subtract: [$prev, Hips.x]
    - convert:
      from: mm
      to: m
      output: Left X COM Dist

    - multiply: [Left X COM Dist, LeftFootContact.fy]
    - multiply: [$prev, 100]
      export: Left AP Force Torque COM
    
    - divide: [$prev, BodyWeightNewton]

- parameter: Left ML Force Torque COM_BW
  where: 
    name: Pitching*
    force: left
  steps:
    - import: LeftFootContact.y
    - subtract: [$prev, Hips.y]
    - convert:
      from: mm
      to: m
      output: Left Y COM Dist

    - multiply: [Left Y COM Dist, LeftFootContact.fx]
    - multiply: [$prev, 100]
      export: Left ML Force Torque COM
    
    - divide: [$prev, BodyWeightNewton]

- parameter: Right AP Force Torque COM_BW
  where: 
    name: Pitching*
    force: right
  steps:
    - import: RightFootContact.x
    - subtract: [$prev, Hips.x]
    - convert:
      from: mm
      to: m
      output: Right X COM Dist

    - multiply: [Right X COM Dist, RightFootContact.fy]
    - multiply: [$prev, 100]
      export: Right AP Force Torque COM
    
    - divide: [$prev, BodyWeightNewton]

- parameter: Right ML Force Torque COM_BW
  where: 
    name: Pitching*
    force: right
  steps:
    - import: RightFootContact.y
    - subtract: [$prev, Hips.y]
    - convert:
      from: mm
      to: m
      output: Right Y COM Dist

    - multiply: [Right Y COM Dist, RightFootContact.fx]
    - multiply: [$prev, 100]
      export: Right ML Force Torque COM
    
    - divide: [$prev, BodyWeightNewton]

- parameter: Lead Foot Total Moment COM_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: Left AP Force Torque COM_BW
      else: Right AP Force Torque COM_BW

- parameter: Trail Foot Total Moment COM_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: Right AP Force Torque COM_BW
      else: Left AP Force Torque COM_BW

- parameter: Left Foot Total Moment COM_BW
  where: 
    name: Pitching*
    force: left
  steps:
    - add: [Left_Free_Moment_BW, Left AP Force Torque COM_BW]
    - add: [$prev, Left ML Force Torque COM_BW]

- parameter: Right Foot Total Moment COM_BW
  where: 
    name: Pitching*
    force: right
  steps:
    - add: [Right_Free_Moment_BW, Right AP Force Torque COM_BW]
    - add: [$prev, Right ML Force Torque COM_BW]

- parameter: Total Horizontal Moment COM_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - add: [Left Foot Total Moment COM_BW, Right Foot Total Moment COM_BW]

# Frontal
- parameter: Left Frontal Cont Total_BW
  where: 
    name: Pitching*
    force: left
  steps:
    - multiply: [LeftFootContact.fx, Hips.z]
    - multiply: [$prev, 100]
    - convert:
      from: mm
      to: m
      output: Left H Force Cont

    - subtract: [LeftFootContact.x, Hips.x]
    - convert:
      from: mm
      to: m
      output: COM X Dist Left
    - multiply: [LeftFootContact.fz, COM X Dist Left]
    - multiply: [$prev, 100]
      output: Left V Force Cont

    - add: [Left H Force Cont, Left V Force Cont]
    - divide: [$prev, BodyWeightNewton]

- parameter: Right Frontal Cont Total_BW
  where: 
    name: Pitching*
    force: right
  steps:
    - multiply: [RightFootContact.fx, Hips.z]
    - multiply: [$prev, 100]
    - convert:
      from: mm
      to: m
      output: Right H Force Cont

    - subtract: [RightFootContact.x, Hips.x]
    - convert:
      from: mm
      to: m
      output: COM X Dist Right
    - multiply: [RightFootContact.fz, COM X Dist Right]
    - multiply: [$prev, 100]
      output: Right V Force Cont

    - add: [Right H Force Cont, Right V Force Cont]
    - divide: [$prev, BodyWeightNewton]

- parameter: Lead Frontal Cont Total_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: Left Frontal Cont Total_BW
      else: Right Frontal Cont Total_BW

- parameter: Trail Frontal Cont Total_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - if: Right_Hand_Vel_max > Left_Hand_Vel_max
      then: Right Frontal Cont Total_BW
      else: Left Frontal Cont Total_BW

- parameter: Total Frontal Moment_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - add: [Left Frontal Cont Total_BW, Right Frontal Cont Total_BW]

# Total
- parameter: Total Moment COM_BW
  where: 
    name: Pitching*
    force: both
  steps:
    - add: [Total Horizontal Moment COM_BW, Total Frontal Moment_BW]

#--------------
# PAF fields
#--------------

- parameter: BALL_RELEASE_SPEED
  where:
    name: Pitching*
  steps:
    - import: $field(Ball speed; measurement; numeric)

- parameter: SPIN_RATE
  where:
    name: Pitching*
  steps:
    - import: $field(Spin rate; measurement; numeric)

- parameter: SPIN_AXIS
  where:
    name: Pitching*
  steps:
    - import: $field(Spin axis; measurement; numeric)


#############
## METRICS ##
#############

- parameter: STRIDE_LENGTH
  where:
    name: Pitching*
  steps:
    - import: LeadFoot => lead
      space: VirtualLab
    - import: BackFoot => throw
      space: VirtualLab
    - subtract: [throw.y@Back_Leg_Footoff, lead.y@Lead_Leg_Footstrike]
    - abs:
    - convert:
      from: mm
      to: m

- parameter: STRIDE_LENGTH_MEAN_PERCENT
  where:
    name: Pitching*
  steps:
    - divide: [STRIDE_LENGTH, $field(Height; measurement; numeric)]
    - multiply: [$prev, 100]
    
- parameter: FeetDist@Release
  where:
    name: Pitching*
  steps:
    - import: LeadFoot@Release => lead
      space: VirtualLab
    - import: BackFoot@Release => throw
      space: VirtualLab
    - subtract: [throw.y, lead.y]
    - abs:
    - convert:
      from: mm
      to: m

- parameter: FeetDist@Release_MEAN_PERCENT
  where:
    name: Pitching*
  steps:
    - divide: [FeetDist@Release, $field(Height; measurement; numeric)]

- parameter: Max_Pelvis_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - import: Pelvis_Ang_Vel
    - eventMask: [$prev.z, Setup, Release100msAfter]
    - max: $prev

- parameter: Max_Thorax_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - import: Thorax_Ang_Vel
    - eventMask: [$prev.z, Setup, Release100msAfter]
    - max: $prev

- parameter: Max_Pitching_Elbow_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Ang_Vel
    - eventMask: [$prev.x, Setup, Release100msAfter]
    - max: $prev

- parameter: Max_Pitching_Hand_Ang_Vel
  where: 
    name: Pitching*
  steps:
    - import: Pitching_Hand_Ang_Vel
    - eventMask: [$prev.y, Setup, Release100msAfter]
    - max: $prev

- parameter: Max_Pelvis_Ang_VelTime
  where:
    name: Pitching*
  steps:
    - eventDuration: [Setup,Max_Pelvis_Ang_Vel_ev]

- parameter: Max_Thorax_Ang_VelTime
  where:
    name: Pitching*
  steps:
    - eventDuration: [Setup,Max_Pitching_Elbow_Ang_Vel_ev]

- parameter: Max_Pitching_Elbow_Ang_VelTime
  where:
    name: Pitching*
  steps:
    - eventDuration: [Setup, Max_Pitching_Elbow_Ang_Vel_ev]

- parameter: Max_Pitching_Hand_Ang_VelTime
  where:
    name: Pitching*
  steps:
    - eventDuration: [Setup,Max_Pitching_Hand_Ang_Vel_ev]

# Pitching Shoulder metrics
- parameter: Pitching_Shoulder_Angle@Setup
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle@Setup

- parameter: Pitching_Shoulder_Angle@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle@Back_Leg_Footoff

- parameter: Pitching_Shoulder_Angle@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle@Backswing_Top

- parameter: Pitching_Shoulder_Angle@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle@Lead_Leg_Footstrike

- parameter: Pitching_Shoulder_Angle@Release
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle@Release

- parameter: Pitching_Shoulder_Angle_XYZ@Setup
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle_XYZ@Setup

- parameter: Pitching_Shoulder_Angle_XYZ@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle_XYZ@Back_Leg_Footoff

- parameter: Pitching_Shoulder_Angle_XYZ@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle_XYZ@Backswing_Top

- parameter: Pitching_Shoulder_Angle_XYZ@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle_XYZ@Lead_Leg_Footstrike

- parameter: Pitching_Shoulder_Angle_XYZ@Release
  where:
    name: Pitching*
  steps:
    - import: Pitching_Shoulder_Angle_XYZ@Release

# Pitching Elbow metrics
- parameter: Pitching_Elbow_Angle@Setup
  where:
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Angle@Setup

- parameter: Pitching_Elbow_Angle@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Angle@Back_Leg_Footoff

- parameter: Pitching_Elbow_Angle@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Angle@Backswing_Top

- parameter: Pitching_Elbow_Angle@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Angle@Lead_Leg_Footstrike

- parameter: Pitching_Elbow_Angle@Release
  where:
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Angle@Release

- parameter: Max Pitching Elbow Flexion
  where:
    name: Pitching*
  steps:
    - import: Pitching_Elbow_Angle.x
    - eventMask: [$prev, Back_Leg_Footoff, Release]
    - max:

# Pelvis metrics
- parameter: Pelvis_Angle@Setup
  where:
    name: Pitching*
  steps:
    - import: Pelvis_Angle@Setup

- parameter: Pelvis_Angle@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Pelvis_Angle@Back_Leg_Footoff

- parameter: Pelvis_Angle@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Pelvis_Angle@Backswing_Top

- parameter: Pelvis_Angle@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Pelvis_Angle@Lead_Leg_Footstrike

- parameter: Pelvis_Angle@Release
  where:
    name: Pitching*
  steps:
    - import: Pelvis_Angle@Release

# Thorax metrics
- parameter: Trunk_Angle@Setup
  where:
    name: Pitching*
  steps:
    - import: Trunk_Angle@Setup

- parameter: Trunk_Angle@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Trunk_Angle@Back_Leg_Footoff

- parameter: Trunk_Angle@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Trunk_Angle@Backswing_Top

- parameter: Trunk_Angle@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Trunk_Angle@Lead_Leg_Footstrike

- parameter: Trunk_Angle@Release
  where:
    name: Pitching*
  steps:
    - import: Trunk_Angle@Release
    
# Hip metrics
- parameter: Lead_Hip_Angle@Setup
  where:
    name: Pitching*
  steps:
    - import: Lead_Hip_Angle@Setup

- parameter: Lead_Hip_Angle@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Lead_Hip_Angle@Back_Leg_Footoff

- parameter: Lead_Hip_Angle@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Lead_Hip_Angle@Backswing_Top

- parameter: Lead_Hip_Angle@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Lead_Hip_Angle@Lead_Leg_Footstrike

- parameter: Lead_Hip_Angle@Release
  where:
    name: Pitching*
  steps:
    - import: Lead_Hip_Angle@Release
    
# Knee metrics
- parameter: Lead_Knee_Angle@Setup
  where:
    name: Pitching*
  steps:
    - import: Lead_Knee_Angle@Setup

- parameter: Lead_Knee_Angle@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Lead_Knee_Angle@Back_Leg_Footoff

- parameter: Lead_Knee_Angle@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Lead_Knee_Angle@Backswing_Top

- parameter: Lead_Knee_Angle@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Lead_Knee_Angle@Lead_Leg_Footstrike

- parameter: Lead_Knee_Angle@Release
  where:
    name: Pitching*
  steps:
    - import: Lead_Knee_Angle@Release
    
# Ankle metrics
- parameter: Lead_Ankle_Angle@Setup
  where:
    name: Pitching*
  steps:
    - import: Lead_Ankle_Angle@Setup

- parameter: Lead_Ankle_Angle@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Lead_Ankle_Angle@Back_Leg_Footoff

- parameter: Lead_Ankle_Angle@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Lead_Ankle_Angle@Backswing_Top

- parameter: Lead_Ankle_Angle@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Lead_Ankle_Angle@Lead_Leg_Footstrike

- parameter: Lead_Ankle_Angle@Release
  where:
    name: Pitching*
  steps:
    - import: Lead_Ankle_Angle@Release
    
# Foot metrics
- parameter: Lead_Foot_wrt_Lab@Setup
  where:
    name: Pitching*
  steps:
    - import: Lead_Foot_wrt_Lab@Setup

- parameter: Lead_Foot_wrt_Lab@Back_Leg_Footoff
  where:
    name: Pitching*
  steps:
    - import: Lead_Foot_wrt_Lab@Back_Leg_Footoff

- parameter: Lead_Foot_wrt_Lab@Backswing_Top
  where:
    name: Pitching*
  steps:
    - import: Lead_Foot_wrt_Lab@Backswing_Top

- parameter: Lead_Foot_wrt_Lab@Lead_Leg_Footstrike
  where:
    name: Pitching*
  steps:
    - import: Lead_Foot_wrt_Lab@Lead_Leg_Footstrike

- parameter: Lead_Foot_wrt_Lab@Release
  where:
    name: Pitching*
  steps:
    - import: Lead_Foot_wrt_Lab@Release

# Hip Shoulder Sep
- parameter: Max Hip Shoulder Sep
  where:
    name: Pitching*
  steps:
    - import: Hip Shoulders Sep
    - eventMask: [$prev.z, Setup, Release]
    - max: 

# Ranking - Kinematics Chain Sequencing
# Calculate rank based on timing of angular velocity peaks
# Rank = 1 + count of other metrics this timing is greater than

- parameter: rank_PELVIS
  where:
    name: Pitching*
  steps:
    - import: Max_Pelvis_Ang_VelTime
      output: pelvis_time
    - import: Max_Thorax_Ang_VelTime
      output: thorax_time
    - import: Max_Pitching_Elbow_Ang_VelTime
      output: elbow_time
    - import: Max_Pitching_Hand_Ang_VelTime
      output: hand_time
    - if: pelvis_time > thorax_time
      then: 1
      else: 0
      output: comp1
    - if: pelvis_time > elbow_time
      then: 1
      else: 0
      output: comp2
    - if: pelvis_time > hand_time
      then: 1
      else: 0
      output: comp3
    - add: [1, comp1, comp2, comp3]

- parameter: rank_TORSO
  where:
    name: Pitching*
  steps:
    - import: Max_Pelvis_Ang_VelTime
      output: pelvis_time
    - import: Max_Thorax_Ang_VelTime
      output: thorax_time
    - import: Max_Pitching_Elbow_Ang_VelTime
      output: elbow_time
    - import: Max_Pitching_Hand_Ang_VelTime
      output: hand_time
    - if: thorax_time > pelvis_time
      then: 1
      else: 0
      output: comp1
    - if: thorax_time > elbow_time
      then: 1
      else: 0
      output: comp2
    - if: thorax_time > hand_time
      then: 1
      else: 0
      output: comp3
    - add: [1, comp1, comp2, comp3]

- parameter: rank_ARM
  where:
    name: Pitching*
  steps:
    - import: Max_Pelvis_Ang_VelTime
      output: pelvis_time
    - import: Max_Thorax_Ang_VelTime
      output: thorax_time
    - import: Max_Pitching_Elbow_Ang_VelTime
      output: elbow_time
    - import: Max_Pitching_Hand_Ang_VelTime
      output: hand_time
    - if: elbow_time > thorax_time
      then: 1
      else: 0
      output: comp1
    - if: elbow_time > pelvis_time
      then: 1
      else: 0
      output: comp2
    - if: elbow_time > hand_time
      then: 1
      else: 0
      output: comp3
    - add: [1, comp1, comp2, comp3]

- parameter: rank_HAND
  where:
    name: Pitching*
  steps:
    - import: Max_Pelvis_Ang_VelTime
      output: pelvis_time
    - import: Max_Thorax_Ang_VelTime
      output: thorax_time
    - import: Max_Pitching_Elbow_Ang_VelTime
      output: elbow_time
    - import: Max_Pitching_Hand_Ang_VelTime
      output: hand_time
    - if: hand_time > thorax_time
      then: 1
      else: 0
      output: comp1
    - if: hand_time > elbow_time
      then: 1
      else: 0
      output: comp2
    - if: hand_time > pelvis_time
      then: 1
      else: 0
      output: comp3
    - add: [1, comp1, comp2, comp3]



